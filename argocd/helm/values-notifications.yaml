notifications:
  secret:
    create: false  # Secret is pre-created manually with slack-api-url; prevent Helm from overwriting it
  notifiers:
    service.webhook.slack: |
      url: $slack-api-url
  # Keys must include template./trigger. prefix â€” chart renders them as-is into argocd-notifications-cm
  templates:
    "template.app-sync-succeeded": |
      webhook:
        slack:
          method: POST
          body: |
            {
              "attachments": [{
                "color": "#18be52",
                "title": "[SYNCED] {{ .app.metadata.name }} synced successfully",
                "title_link": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}",
                "fields": [
                  { "title": "Environment", "value": "{{.app.metadata.namespace}}", "short": true },
                  { "title": "Revision", "value": "{{.app.status.sync.revision}}", "short": true },
                  { "title": "Status", "value": "{{.app.status.sync.status}}", "short": true },
                  { "title": "Health", "value": "{{.app.status.health.status}}", "short": true }
                ]
              }]
            }
    "template.app-sync-failed": |
      webhook:
        slack:
          method: POST
          body: |
            {
              "attachments": [{
                "color": "#E96D76",
                "title": "[FAILED] {{ .app.metadata.name }} sync failed",
                "title_link": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}",
                "fields": [
                  { "title": "Environment", "value": "{{.app.metadata.namespace}}", "short": true },
                  { "title": "Revision", "value": "{{.app.status.sync.revision}}", "short": true },
                  { "title": "Sync Status", "value": "{{.app.status.sync.status}}", "short": true },
                  { "title": "Phase", "value": "{{.app.status.operationState.phase}}", "short": true },
                  { "title": "Message", "value": "{{.app.status.operationState.message}}", "short": false }
                ]
              }]
            }
    "template.app-health-degraded": |
      webhook:
        slack:
          method: POST
          body: |
            {
              "attachments": [{
                "color": "#dc3545",
                "title": "[DEGRADED] {{ .app.metadata.name }} health degraded",
                "title_link": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}",
                "fields": [
                  { "title": "Environment", "value": "{{.app.metadata.namespace}}", "short": true },
                  { "title": "Health", "value": "{{.app.status.health.status}}", "short": true },
                  { "title": "Message", "value": "{{.app.status.health.message}}", "short": false }
                ]
              }]
            }
    "template.app-health-healthy": |
      webhook:
        slack:
          method: POST
          body: |
            {
              "attachments": [{
                "color": "#18be52",
                "title": "[HEALTHY] {{ .app.metadata.name }} is back to healthy",
                "title_link": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}",
                "fields": [
                  { "title": "Environment", "value": "{{.app.metadata.namespace}}", "short": true },
                  { "title": "Health", "value": "{{.app.status.health.status}}", "short": true }
                ]
              }]
            }
    "template.app-out-of-sync": |
      webhook:
        slack:
          method: POST
          body: |
            {
              "attachments": [{
                "color": "#f4c030",
                "title": "[OUT-OF-SYNC] {{ .app.metadata.name }} is out of sync",
                "title_link": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}",
                "fields": [
                  { "title": "Environment", "value": "{{.app.metadata.namespace}}", "short": true },
                  { "title": "Revision", "value": "{{.app.status.sync.revision}}", "short": true },
                  { "title": "Sync Status", "value": "{{.app.status.sync.status}}", "short": true }
                ]
              }]
            }
  triggers:
    "trigger.on-sync-succeeded": |
      - when: app.status.operationState != nil && app.status.operationState.phase in ['Succeeded']
        send: [app-sync-succeeded]
    "trigger.on-sync-failed": |
      - when: app.status.operationState != nil && app.status.operationState.phase in ['Error', 'Failed']
        send: [app-sync-failed]
    "trigger.on-sync-succeeded-with-changes": |
      - when: app.status.operationState != nil && app.status.operationState.phase in ['Succeeded'] && app.status.operationState.syncResult != nil && app.status.operationState.syncResult.revision != nil
        oncePer: app.status.operationState.syncResult.revision
        send: [app-sync-succeeded]
    "trigger.on-health-degraded": |
      - when: app.status.health != nil && app.status.health.status == 'Degraded'
        send: [app-health-degraded]
    "trigger.on-health-healthy": |
      - when: app.status.health != nil && app.status.health.status == 'Healthy'
        oncePer: app.status.operationState.syncResult.revision
        send: [app-health-healthy]
    "trigger.on-out-of-sync": |
      - when: app.status.sync != nil && app.status.sync.status == 'OutOfSync'
        send: [app-out-of-sync]
  subscriptions:
    - recipients:
        - slack
      triggers:
        - on-sync-succeeded-with-changes
        - on-health-degraded
        - on-health-healthy
        - on-out-of-sync
