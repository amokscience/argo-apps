# Strategic merge patch for argocd-repo-server Deployment
# Adds an init container to download and use a specific Helm version
# 
# This patch is applied via Kustomize to inject Helm version switching capability
# into the repo-server pod without rebuilding the container image.

apiVersion: apps/v1
kind: Deployment
metadata:
  name: argocd-repo-server
  namespace: argocd
spec:
  template:
    spec:
      # Add init container before any other containers
      initContainers:
      - name: copyutil
        # Fix for ArgoCD v3 bug: ln -s fails if symlink already exists after container restart
        # Override args to use ln -sf (force) instead of ln -s
        args:
          - /bin/cp --update=none /usr/local/bin/argocd /var/run/argocd/argocd && /bin/ln -sf /var/run/argocd/argocd /var/run/argocd/argocd-cmp-server
      - name: install-helm-version
        # Pin the Helm version in the image tag - no download needed at runtime.
        # To change versions: update the tag and re-apply the patch.
        image: alpine/helm:3.17.1
        command:
          - sh
          - -c
          - |
            set -e
            # Copy the helm binary from this image into the emptyDir volume.
            # The main container will mount it via subPath over /usr/local/bin/helm.
            cp /usr/bin/helm /helm-override/helm
            chmod +x /helm-override/helm
            echo "[INFO] Staged Helm version:"
            /helm-override/helm version
        volumeMounts:
        - name: helm-override
          mountPath: /helm-override
      
      # emptyDir staging area for the custom helm binary
      volumes:
      - name: helm-override
        emptyDir: {}
      
      # Mount only /usr/local/bin/helm via subPath so other binaries in the
      # argocd-repo-server image (/usr/local/bin/kustomize, git, etc.) are untouched.
      containers:
      - name: argocd-repo-server
        volumeMounts:
        - name: helm-override
          mountPath: /usr/local/bin/helm
          subPath: helm
