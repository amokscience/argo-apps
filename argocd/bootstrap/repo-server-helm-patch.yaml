# Strategic merge patch for argocd-repo-server Deployment
# Adds an init container to download and use a specific Helm version
# 
# This patch is applied via Kustomize to inject Helm version switching capability
# into the repo-server pod without rebuilding the container image.

apiVersion: apps/v1
kind: Deployment
metadata:
  name: argocd-repo-server
  namespace: argocd
spec:
  template:
    spec:
      # Add init container before any other containers
      initContainers:
      - name: copyutil
        # Fix for ArgoCD v3 bug: ln -s fails if symlink already exists after container restart
        # Override args to use ln -sf (force) instead of ln -s
        args:
          - /bin/cp --update=none /usr/local/bin/argocd /var/run/argocd/argocd && /bin/ln -sf /var/run/argocd/argocd /var/run/argocd/argocd-cmp-server
      - name: install-helm-version
        image: alpine:3.18
        command:
          - sh
          - -c
          - |
            set -e
            # Helm version to install. Change this value and re-apply the patch
            # (kubectl apply -k argocd/bootstrap/) then restart repo-server.
            HELM_VERSION="3.17.1"

            echo "[INFO] Installing Helm v${HELM_VERSION}"
            apk add --no-cache curl tar gzip

            cd /tmp
            HELM_URL="https://get.helm.sh/helm-v${HELM_VERSION}-linux-amd64.tar.gz"
            echo "[INFO] Downloading: ${HELM_URL}"

            if ! curl -fL "${HELM_URL}" -o helm.tar.gz; then
              echo "[ERROR] Failed to download Helm v${HELM_VERSION}"
              exit 1
            fi

            tar xzf helm.tar.gz

            # Write into the emptyDir volume (mounted at /helm-override)
            # This file is then subPath-mounted over /usr/local/bin/helm in
            # argocd-repo-server, replacing only the helm binary.
            cp linux-amd64/helm /helm-override/helm
            chmod +x /helm-override/helm

            echo "[INFO] Successfully staged Helm v${HELM_VERSION}:"
            /helm-override/helm version
        volumeMounts:
        - name: helm-override
          mountPath: /helm-override
      
      # emptyDir staging area for the custom helm binary
      volumes:
      - name: helm-override
        emptyDir: {}
      
      # Mount only /usr/local/bin/helm via subPath so other binaries in the
      # argocd-repo-server image (/usr/local/bin/kustomize, git, etc.) are untouched.
      containers:
      - name: argocd-repo-server
        volumeMounts:
        - name: helm-override
          mountPath: /usr/local/bin/helm
          subPath: helm
