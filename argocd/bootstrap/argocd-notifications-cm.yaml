apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  # ============================================================================
  # Service - Slack via incoming webhook
  # NOTE: `url: $slack-api-url` resolves from secret `argocd-notifications-secret`
  # NOTE: Do NOT use `$argocd-notifications-secret:slack-api-url` here (unsupported)
  # NOTE: Keep webhook recipient name and template target as `slack` (see subscriptions)
  # slack-api-url is stored in argocd-notifications-secret under key slack-api-url
  # ============================================================================
  service.webhook.slack: |
    url: $slack-api-url

  # ============================================================================
  # Templates
  # NOTE: Keep titles ASCII-safe. Emoji/special chars can be mangled by encoding
  # pipelines and lead to invalid template parsing at runtime.
  # ============================================================================
  template.app-sync-succeeded: |
    webhook:
      slack:
        method: POST
        body: |
          {
            "attachments": [{
              "color": "#18be52",
              "title": "[SYNCED] {{ .app.metadata.name }} synced successfully",
              "title_link": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}",
              "fields": [
                { "title": "Environment", "value": "{{.app.metadata.namespace}}", "short": true },
                { "title": "Revision", "value": "{{.app.status.sync.revision}}", "short": true },
                { "title": "Status", "value": "{{.app.status.sync.status}}", "short": true },
                { "title": "Health", "value": "{{.app.status.health.status}}", "short": true }
              ]
            }]
          }

  template.app-sync-failed: |
    webhook:
      slack:
        method: POST
        body: |
          {
            "attachments": [{
              "color": "#E96D76",
              "title": "[FAILED] {{ .app.metadata.name }} sync failed",
              "title_link": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}",
              "fields": [
                { "title": "Environment", "value": "{{.app.metadata.namespace}}", "short": true },
                { "title": "Revision", "value": "{{.app.status.sync.revision}}", "short": true },
                { "title": "Sync Status", "value": "{{.app.status.sync.status}}", "short": true },
                { "title": "Phase", "value": "{{.app.status.operationState.phase}}", "short": true },
                { "title": "Message", "value": "{{.app.status.operationState.message}}", "short": false }
              ]
            }]
          }

  template.app-health-degraded: |
    webhook:
      slack:
        method: POST
        body: |
          {
            "attachments": [{
              "color": "#f4c030",
              "title": "[DEGRADED] {{ .app.metadata.name }} health degraded",
              "title_link": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}",
              "fields": [
                { "title": "Environment", "value": "{{.app.metadata.namespace}}", "short": true },
                { "title": "Health", "value": "{{.app.status.health.status}}", "short": true },
                { "title": "Message", "value": "{{.app.status.health.message}}", "short": false }
              ]
            }]
          }

  template.app-out-of-sync: |
    webhook:
      slack:
        method: POST
        body: |
          {
            "attachments": [{
              "color": "#8a8a8a",
              "title": "[OUT-OF-SYNC] {{ .app.metadata.name }} is out of sync",
              "title_link": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}",
              "fields": [
                { "title": "Environment", "value": "{{.app.metadata.namespace}}", "short": true },
                { "title": "Revision", "value": "{{.app.status.sync.revision}}", "short": true },
                { "title": "Sync Status", "value": "{{.app.status.sync.status}}", "short": true }
              ]
            }]
          }

  # ============================================================================
  # Triggers
  # NOTE: Keep nil checks to avoid evaluation errors when status fields are unset
  # (e.g. operationState can be nil before first sync operation).
  # ============================================================================
  trigger.on-sync-succeeded: |
    - when: app.status.operationState != nil && app.status.operationState.phase in ['Succeeded']
      send: [app-sync-succeeded]

  trigger.on-sync-failed: |
    - when: app.status.operationState != nil && app.status.operationState.phase in ['Error', 'Failed']
      send: [app-sync-failed]

  trigger.on-health-degraded: |
    - when: app.status.health != nil && app.status.health.status == 'Degraded'
      send: [app-health-degraded]

  trigger.on-out-of-sync: |
    - when: app.status.sync != nil && app.status.sync.status == 'OutOfSync'
      send: [app-out-of-sync]

  # ============================================================================
  # Default subscriptions - applies to all applications
  # NOTE: For webhook services, recipient MUST be the webhook name only (`slack`).
  # Using `webhook:slack` causes: "notification service 'webhook' is not supported".
  # ============================================================================
  defaultTriggers: |
    - on-health-degraded
    - on-out-of-sync

  subscriptions: |
    - recipients:
        - slack
      triggers:
        - on-health-degraded
        - on-out-of-sync

  # ArgoCD URL used in notification links
  context: |
    argocdUrl: https://argocd.amok
